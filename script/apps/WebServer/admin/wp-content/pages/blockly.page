<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Blockly Test</title>
  <?npl
  wp_enqueue_script("jquery", "/wp-includes/js/jquery/jquery.min.js", nil, "1.11.1");
  ?>
    <script src="/wp-includes/js/blockly/blockly_compressed.js"></script>
    <script src="/wp-includes/js/blockly/blocks_compressed.js"></script>
    <script src="/wp-includes/js/blockly/lua_compressed.js"></script>
    <script src="/wp-includes/js/blockly/msg/js/en.js"></script>
    <script src="/wp-includes/js/BlockParaCraft_Layout.js"></script>
    <script src="/wp-includes/js/BlockParaCraft_Lua.js"></script>
    <script>
      var gDate = new Date();
      var gPageKey = gDate.getTime();
      var gWorkSpace;
      var gParaCraft_Start;
      function onWorkSpaceEvent(event) {
        if (event.type == Blockly.Events.CREATE) {
          var block = gWorkSpace.getBlockById(event.blockId);
          if (block.type == "ParaCraft_Start") {
            gParaCraft_Start = event.blockId;
            gWorkSpace.updateToolbox(document.getElementById('toolbox2'));
          }
        }
        else if (event.type == Blockly.Events.DELETE) {
          if (event.blockId == gParaCraft_Start) {
            gWorkSpace.updateToolbox(document.getElementById('toolbox'));
          }
        }
      }
      function start() {
        gWorkSpace = Blockly.inject('blocklyDiv',
          { toolbox: document.getElementById('toolbox') });
        gWorkSpace.addChangeListener(onWorkSpaceEvent);
      }
      function reset() {
        var string_code = 'local CommandManager = commonlib.gettable("MyCompany.Aries.Game.CommandManager")\r\nCommandManager:RunCommand("/BlocklyReset '+ gPageKey +'")';
        $.post("/ajax/console?action=runcode", { text: string_code.valueOf() });
      }
      function run() {
        var code = Blockly.Lua.workspaceToCode(gWorkSpace);
        var string_code = new String(code);
        var start_index = string_code.indexOf("ParaCraft_Start;");
        if (start_index >= 0) {
          string_code = string_code.substring(start_index + 16);
          var end_index = string_code.indexOf("\n\n");
          if (end_index >= 0) { string_code = string_code.substring(0, end_index + 1); }
          var temp = string_code;
          string_code = "";
          while (temp.indexOf("\r") >= 0) {
            string_code = string_code + temp.substring(0, temp.indexOf("\r")) + "\\r";
            var temp = temp.substring(temp.indexOf("\r") + 1);
          }
          string_code = string_code + temp;
          temp = string_code;
          string_code = "";
          while (temp.indexOf("\n") >= 0) {
            string_code = string_code + temp.substring(0, temp.indexOf("\n")) + "\\n";
            var temp = temp.substring(temp.indexOf("\n") + 1);
          }
          string_code = string_code + temp;
          document.getElementById('LuaCode').value = string_code.valueOf();
          string_code = gPageKey + "\\n" + string_code;
          string_code = 'local CommandManager = commonlib.gettable("MyCompany.Aries.Game.CommandManager")\r\nCommandManager:RunCommand("/RunBlocklyCode ' + string_code + '")';
          $.post("/ajax/console?action=runcode", { text: string_code.valueOf() });
        }
      }
      function onClickRun() {
        var element = document.getElementById("Run");
        if (element.innerHTML == "运行") {
          element.innerHTML = "重置";
          run();
        }
        else {
          element.innerHTML = "运行";
          reset();
        }
      }
    </script>
</head>

<body onload="start()">
  <button id="Run" onclick="onClickRun()">运行</button>
  <textarea id="LuaCode" style="height: 400px; width: 200px;">实时lua代码</textarea>
  <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
  <xml id="toolbox" style="display: none">
    <block type="ParaCraft_Start"></block>
    <block type="ParaCraft_FarwardStep"></block>
    <block type="ParaCraft_TurnLeft"></block>
    <block type="ParaCraft_TurnRight"></block>
    <block type="ParaCraft_DestroyBlock"></block>
  </xml>
  <xml id="toolbox2" style="display: none">
    <block type="ParaCraft_Start" disabled="true"></block>
    <block type="ParaCraft_FarwardStep"></block>
    <block type="ParaCraft_TurnLeft"></block>
    <block type="ParaCraft_TurnRight"></block>
    <block type="ParaCraft_DestroyBlock"></block>
  </xml>
</body>

</html>